<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <h2>Total Number of Covid19 Cases</h2>
    <div id="barchart_total_cases_per_country"></div>
    <h2>Covid19 Trends</h2>
    <p>Hover over the Legend to see something special :)</p>
    <div id="linechart_covid_cases"></div>
    <h2>Individual Charts</h2>
    <div id="china_graph"></div>

    <style>
      h2,
      p {
        text-align: center;
      }
      #barchart_total_cases_per_country {
        justify-content: center;
        display: flex;
      }

      #linechart_covid_cases {
        justify-content: center;
        display: flex;
      }

      div.tooltip {
        position: absolute;
        text-align: left;
        width: auto;
        height: auto;
        padding: 4px;
        font: 12px sans-serif;
        /* color: #fff;
        background: rgba(0, 0, 0, 0.8); */
        background-color: white;
        border: solid;
        border-width: 2px;
        /* border: 0px; */
        border-radius: 5px;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.0/moment.min.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script>
      var italyList = [];
      var franceList = [];
      var spainList = [];
      var germanyList = [];
      var ukList = [];
      var usaList = [];
      var chinaList = [];
      var listOfLists = [
        italyList,
        franceList,
        spainList,
        germanyList,
        ukList,
        usaList,
        chinaList,
      ];
      var countries = [];
      var totalCasesPerCountry = [];
      var highestNumberOfCases = 0;

      // set the dimensions and margins of the graph
      var margin = { top: 10, right: 120, bottom: 90, left: 120 },
        width = 760 - margin.left - margin.right,
        height = 750 - margin.top - margin.bottom;

      // append the svg object to the body of the page
      var svg = d3
        .select("#barchart_total_cases_per_country")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // retrieve covid data
      Promise.all([
        d3.csv(
          "https://wyjgrace.github.io/info-viz/WHO-COVID-19-global-data.csv"
        ),
      ]).then((data) => {
        for (let i = 0; i < data[0].length; i++) {
          if (data[0][i].Country_code === "IT") {
            if (!countries.includes(data[0][i].Country)) {
              countries.push(data[0][i].Country);
            }
            italyList.push(data[0][i]);
          } else if (data[0][i].Country_code === "FR") {
            if (!countries.includes(data[0][i].Country)) {
              countries.push(data[0][i].Country);
            }
            franceList.push(data[0][i]);
          } else if (data[0][i].Country_code === "ES") {
            if (!countries.includes(data[0][i].Country)) {
              countries.push(data[0][i].Country);
            }
            spainList.push(data[0][i]);
          } else if (data[0][i].Country_code === "DE") {
            if (!countries.includes(data[0][i].Country)) {
              countries.push(data[0][i].Country);
            }
            germanyList.push(data[0][i]);
          } else if (data[0][i].Country_code === "GB") {
            if (!countries.includes(data[0][i].Country)) {
              countries.push(data[0][i].Country);
            }
            ukList.push(data[0][i]);
          } else if (data[0][i].Country_code === "US") {
            if (!countries.includes(data[0][i].Country)) {
              countries.push(data[0][i].Country);
            }
            usaList.push(data[0][i]);
          } else if (data[0][i].Country_code === "CN") {
            if (!countries.includes(data[0][i].Country)) {
              countries.push(data[0][i].Country);
            }
            chinaList.push(data[0][i]);
          }
        }

        // X axis
        var x = d3
          .scaleBand()
          .range([0, width])
          .domain(
            countries.map(function (d) {
              return d;
            })
          )
          .padding(0.2);
        svg
          .append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x))
          .selectAll("text")
          .attr("transform", "translate(-10,0)rotate(-45)")
          .style("text-anchor", "end");

        svg
          .append("text")
          .attr("x", -(height / 2))
          .attr("y", -90)
          .attr("transform", "rotate(-90)")
          .attr("text-anchor", "middle")
          .text("Number of Cases");

        for (let i = 0; i < listOfLists.length; i++) {
          if (
            listOfLists[i][listOfLists[i].length - 1].Cumulative_cases >
            highestNumberOfCases
          ) {
            highestNumberOfCases =
              listOfLists[i][listOfLists[i].length - 1].Cumulative_cases;
          }
          totalCasesPerCountry.push({
            country: listOfLists[i][listOfLists[i].length - 1].Country,
            total_cases:
              listOfLists[i][listOfLists[i].length - 1].Cumulative_cases,
          });
        }

        // Add Y axis
        var y = d3
          .scaleLinear()
          .domain([0, highestNumberOfCases])
          .range([height, 0]);
        svg.append("g").call(d3.axisLeft(y));

        svg
          .append("text")
          .attr("x", width / 2)
          .attr("y", 700)
          .attr("text-anchor", "middle")
          .text("Countries");

        const colorByCountry = d3
          .scaleThreshold()
          .domain(countries)
          .range([
            "#fff",
            "#003f5c",
            "#374c80",
            "#7a5195",
            "#bc5090",
            "#ef5675",
            "#ff764a",
            "#ffa600",
          ]);

        var div = d3
          .select("body")
          .append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);

        // Bars
        svg
          .selectAll("mybar")
          .data(totalCasesPerCountry)
          .enter()
          .append("rect")
          .attr("x", function (d) {
            return x(d.country);
          })
          .attr("width", x.bandwidth())
          .attr("fill", (d) => colorByCountry(d.country))
          .style("opacity", 0.8)
          // no bar at the beginning thus:
          .attr("height", function (d) {
            return height - y(0);
          }) // always equal to 0
          .attr("y", function (d) {
            return y(0);
          })
          .on("mouseover", function (event, d) {
            div.transition().duration(200).style("opacity", 0.9);
            div
              .html(
                "<strong>Country:</strong> " +
                  d.country +
                  "<br/><strong>Covid19 Cases:</strong> " +
                  d.total_cases
              )
              .style("left", event.pageX + "px")
              .style("top", event.pageY - 28 + "px");
            d3.select(this).style("stroke", "black").style("opacity", 1);
          })
          .on("mouseout", function (d) {
            div.transition().duration(500).style("opacity", 0);
            d3.select(this).style("stroke", "none").style("opacity", 0.8);
          });

        // Animation
        svg
          .selectAll("rect")
          .transition()
          .duration(800)
          .attr("y", function (d) {
            return y(d.total_cases);
          })
          .attr("height", function (d) {
            return height - y(d.total_cases);
          })
          .delay(function (d, i) {
            return i * 100;
          });

        // line chart starts here

        const width_line = 1200 - margin.left - margin.right;

        var svgLine = d3
          .select("#linechart_covid_cases")
          .append("svg")
          .attr("width", width_line + 150 + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        const sevenCountriesData = data[0].filter(
          (item) =>
            item.Country_code == "IT" ||
            item.Country_code == "FR" ||
            item.Country_code == "ES" ||
            item.Country_code == "GB" ||
            item.Country_code == "DE" ||
            item.Country_code == "US" ||
            item.Country_code == "CN"
        );

        const sumstat = d3.group(sevenCountriesData, (d) => d.Country);

        // Add X axis --> it is a date format
        var x_line = d3
          .scaleTime()
          .domain(
            d3.extent(sevenCountriesData, function (d) {
              return new Date(d.Date_reported);
            })
          )
          .range([0, width_line]);
        svgLine
          .append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x_line).ticks(5));

        // Add Y axis
        const y_line = d3
          .scaleLinear()
          .domain([
            d3.min(sevenCountriesData, function (d) {
              return +d.New_cases;
            }),
            d3.max(sevenCountriesData, function (d) {
              return +d.New_cases;
            }),
          ])
          .range([height, 0]);
        svgLine.append("g").call(d3.axisLeft(y_line));

        // Draw the line
        svgLine
          .selectAll(".line")
          .data(sumstat)
          .join("path")
          .attr("fill", "none")
          .attr("class", function (d) {
            return d[0].replace(/\s+/g, "-");
          })
          .attr("stroke", function (d) {
            return colorByCountry(d[0]);
          })
          .attr("stroke-width", 1.5)
          .transition()
          .duration(2000)
          .delay(function (d, i) {
            return i * 500;
          })
          .attr("d", function (d) {
            return d3
              .line()
              .x(function (d) {
                return x_line(new Date(d.Date_reported));
              })
              .y(function (d) {
                return y_line(+d.New_cases);
              })(d[1]);
          });

        // CREATE LEGEND //
        var svgLegend = svgLine
          .append("g")
          .attr("class", "gLegend")
          .attr("transform", "translate(" + (width + 500) + "," + 500 + ")");

        var legend = svgLegend
          .selectAll(".legend")
          .data(sumstat)
          .enter()
          .append("g")
          .attr("class", "legend")
          .attr("transform", function (d, i) {
            return "translate(0," + i * 20 + ")";
          })
          .on("mouseover", function () {
            let selectedCountry = d3.select(this)._groups[0][0].__data__[0];

            for (let i = 0; i < countries.length; i++) {
              if (
                countries[i].replace(/\s+/g, "-") !=
                selectedCountry.replace(/\s+/g, "-")
              ) {
                d3.selectAll("path." + countries[i].replace(/\s+/g, "-")).style(
                  "stroke-opacity",
                  "0"
                );
              }
            }
          })
          .on("mouseout", function () {
            let selectedCountry = d3.select(this)._groups[0][0].__data__[0];

            for (let i = 0; i < countries.length; i++) {
              if (
                countries[i].replace(/\s+/g, "-") !=
                selectedCountry.replace(/\s+/g, "-")
              ) {
                d3.selectAll("path." + countries[i].replace(/\s+/g, "-")).style(
                  "stroke-opacity",
                  "1"
                );
              }
            }
          });

        legend
          .append("circle")
          .attr("class", "legend-node")
          .attr("cx", 0)
          .attr("cy", 0)
          .attr("r", 7)
          .style("fill", (d) => colorByCountry(d[0]));

        legend
          .append("text")
          .attr("class", "legend-text")
          .attr("x", 7 * 2)
          .attr("y", 7 / 2)
          .style("fill", "#000")
          .style("font-size", 12)
          .text((d) => d[0]);

        // testing
        var mouseG = svgLine.append("g").attr("class", "mouse-over-effects");

        mouseG
          .append("path") // this is the black vertical line to follow mouse
          .attr("class", "mouse-line")
          .style("stroke", "black")
          .style("stroke-width", "1px")
          .style("opacity", "0");

        var mousePerLine = mouseG
          .selectAll(".mouse-per-line")
          .data(sumstat)
          .enter()
          .append("g")
          .attr("class", "mouse-per-line");

        var lines = [];
        for (let i = 0; i < countries.length; i++) {
          lines.push(
            document.querySelectorAll(
              "path." + countries[i].replace(/\s+/g, "-")
            )
          );
        }
        // console.log(lines);

        var mousePerLine = mouseG
          .selectAll(".mouse-per-line")
          .data(sumstat)
          .enter()
          .append("g")
          .attr("class", "mouse-per-line");

        mousePerLine
          .append("circle")
          .attr("r", 7)
          .style("stroke", function (d) {
            return colorByCountry(d[0]);
          })
          .style("fill", "none")
          .style("stroke-width", "1px")
          .style("opacity", "0");

        mousePerLine.append("text").attr("transform", "translate(10,3)");

        mouseG
          .append("svgLine:rect") // append a rect to catch mouse movements on canvas
          .attr("width", width) // can't catch mouse events on a g element
          .attr("height", height)
          .attr("fill", "none")
          .attr("pointer-events", "all")
          .on("mouseout", function () {
            // on mouse out hide line, circles and text
            d3.select(".mouse-line").style("opacity", "0");
            d3.selectAll(".mouse-per-line circle").style("opacity", "0");
            d3.selectAll(".mouse-per-line text").style("opacity", "0");
          })
          .on("mouseover", function () {
            // on mouse in show line, circles and text
            d3.select(".mouse-line").style("opacity", "1");
            d3.selectAll(".mouse-per-line circle").style("opacity", "1");
            d3.selectAll(".mouse-per-line text").style("opacity", "1");
          })
          .on("mousemove", function (e) {
            // mouse moving over canvas
            var mouse = e.clientX;
            d3.select(".mouse-line").attr("d", function () {
              var d = "M" + mouse + "," + height;
              d += " " + mouse + "," + 0;
              return d;
            });

            d3.selectAll(".mouse-per-line").attr("transform", function (d, i) {
              var xDate = x_line.invert(mouse),
                bisect = d3.bisector(function (d) {
                  return new Date(d.Date_reported);
                }).right;
              idx = bisect(d.New_cases, xDate);

              var beginning = 0,
                end = lines[i].getTotalLength(),
                target = null;

              while (true) {
                target = Math.floor((beginning + end) / 2);
                pos = lines[i].getPointAtLength(target);
                if (
                  (target === end || target === beginning) &&
                  pos.x_line !== mouse
                ) {
                  break;
                }
                if (pos.x_line > mouse) end = target;
                else if (pos.x_line < mouse) beginning = target;
                else break; //position found
              }

              d3.select(this)
                .select("text")
                .text(y_line.invert(pos.y_line).toFixed(2));

              return "translate(" + mouse + "," + pos.y_line + ")";
            });
          });

        //// test!!

        // set the dimensions and margins of the graph
        var margins = { top: 10, right: 30, bottom: 30, left: 60 },
          widths = 460 - margins.left - margins.right,
          heights = 400 - margins.top - margins.bottom;

        // append the svg object to the body of the page
        var svgc = d3
          .select("#china_graph")
          .append("svg")
          .attr("width", widths + margins.left + margins.right)
          .attr("height", heights + margins.top + margins.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margins.left + "," + margins.top + ")"
          );

        // Add X axis --> it is a date format
        var x = d3
          .scaleTime()
          .domain(
            d3.extent(chinaList, function (d) {
              return new Date(d.Date_reported);
            })
          )
          .range([0, widths]);
        svgc
          .append("g")
          .attr("transform", "translate(0," + heights + ")")
          .call(d3.axisBottom(x));

        // Add Y axis
        var y = d3
          .scaleLinear()
          .domain([
            d3.min(chinaList, function (d) {
              return +d.New_deaths;
            }),
            d3.max(chinaList, function (d) {
              return +d.New_deaths;
            }),
          ])
          .range([heights, 0]);
        svgc.append("g").call(d3.axisLeft(y));

        // This allows to find the closest X index of the mouse:
        var bisect = d3.bisector(function (d) {
          return d.x;
        }).left;

        // Create the circle that travels along the curve of chart
        var focus = svgc
          .append("g")
          .append("circle")
          .style("fill", "none")
          .attr("stroke", "black")
          .attr("r", 8.5)
          .style("opacity", 0);

        // Create the text that travels along the curve of chart
        var focusText = svgc
          .append("g")
          .append("text")
          .style("opacity", 0)
          .attr("text-anchor", "left")
          .attr("alignment-baseline", "middle");

        // Add the line
        svgc
          .append("path")
          .datum(chinaList)
          .attr("fill", "none")
          .attr("stroke", "steelblue")
          .attr("stroke-width", 1.5)
          .attr(
            "d",
            d3
              .line()
              .x(function (d) {
                return x(new Date(d.Date_reported));
              })
              .y(function (d) {
                return y(d.New_deaths);
              })
          );

        svgc
          .append("path")
          .datum(chinaList)
          .attr("fill", "none")
          .attr("stroke", "red")
          .attr("stroke-width", 1.5)
          .attr(
            "d",
            d3
              .line()
              .x(function (d) {
                return x(new Date(d.Date_reported));
              })
              .y(function (d) {
                return y(d.New_cases);
              })
          );

        // Create a rect on top of the svg area: this rectangle recovers mouse position
        svgc
          .append("rect")
          .style("fill", "none")
          .style("pointer-events", "all")
          .attr("width", widths)
          .attr("height", heights);
        //   .on("mouseover", mouseover)
        //   .on("mousemove", mousemove)
        //   .on("mouseout", mouseout);

        // What happens when the mouse move -> show the annotations at the right positions.
        function mouseover() {
          focus.style("opacity", 1);
          focusText.style("opacity", 1);
        }

        function mousemove() {
          // recover coordinate we need
          var x0 = x.invert(e.clientX);
          var i = bisect(chinaList, x0, 1);
          selectedData = chinaList[i];
          focus.attr("cx", x(selectedData.x)).attr("cy", y(selectedData.y));
          focusText
            .html("HELLO")
            // .html("x:" + selectedData.x + "  -  " + "y:" + selectedData.y)
            .attr("x", x(selectedData.x) + 15)
            .attr("y", y(selectedData.y));
        }
        function mouseout() {
          focus.style("opacity", 0);
          focusText.style("opacity", 0);
        }
      });
    </script>
  </body>
</html>
